"use client";

import { useState, useEffect } from "react";
import {
  Combobox,
  ComboboxContent,
  ComboboxEmpty,
  ComboboxInput,
  ComboboxItem,
  ComboboxList,
} from "@/components/ui/combobox";
import { Label } from "@/components/ui/label";
import { Field, FieldLabel } from "@/components/ui/field";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

type HomeClientProps = {
  items: string[];
  storageKey?: string;
};

export default function HomeClient({
  items,
  storageKey = "rationDetails",
}: HomeClientProps) {
  const nameKey = `${storageKey}:name`;
  const rationKey = `${storageKey}:rationType`;

  const [selectedName, setSelectedName] = useState<string>("");
  const [rationType, setRationType] = useState<string>("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitError, setSubmitError] = useState<string>("");
  const [submitSuccess, setSubmitSuccess] = useState<string>("");

  // Load saved values
  useEffect(() => {
    try {
      const savedName = localStorage.getItem(nameKey);
      const savedRation = localStorage.getItem(rationKey);

      if (savedName) setSelectedName(savedName);
      if (savedRation) setRationType(savedRation);
    } catch {
      // ignore
    }
  }, [nameKey, rationKey]);

  // Persist name
  useEffect(() => {
    try {
      if (selectedName) localStorage.setItem(nameKey, selectedName);
      else localStorage.removeItem(nameKey);
    } catch {
      // ignore
    }
  }, [selectedName, nameKey]);

  // Persist ration type
  useEffect(() => {
    try {
      if (rationType) localStorage.setItem(rationKey, rationType);
      else localStorage.removeItem(rationKey);
    } catch {
      // ignore
    }
  }, [rationType, rationKey]);

  const clearAll = () => {
    setSelectedName("");
    setRationType("");
    setSubmitError("");
    setSubmitSuccess("");

    try {
      localStorage.removeItem(nameKey);

      localStorage.removeItem(rationKey);
    } catch {
      // ignore
    }
  };

  const canSubmit = Boolean(selectedName.trim()) && Boolean(rationType.trim());

  const handleSubmit = async () => {
    setSubmitError("");
    setSubmitSuccess("");

    if (!canSubmit) {
      setSubmitError("Please select your name and ration type.");
      return;
    }

    setIsSubmitting(true);

    try {
      const res = await fetch("/api/addRation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: selectedName.trim(),
          rationType: rationType.trim(),
        }),
      });

      // Try to parse JSON for helpful error messages

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        const msg =
          data?.error ||
          data?.message ||
          `Failed to submit (HTTP ${res.status})`;
        throw new Error(msg);
      }

      setSubmitSuccess("Submitted successfully.");

      // Optional: clear after successful submit
      // clearAll();
    } catch (e: any) {
      setSubmitError(e?.message || "Something went wrong submitting.");
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="flex flex-col gap-5">
      <div className="flex gap-3 flex-col">
        <Label htmlFor="name">Your Name</Label>

        <Combobox
          items={items}
          value={selectedName}
          onValueChange={(val) => setSelectedName(val || "")}
        >
          <ComboboxInput id="name" placeholder="Enter your name" />
          <ComboboxContent>
            <ComboboxEmpty>No name found</ComboboxEmpty>
            <ComboboxList>
              {(item) => (
                <ComboboxItem key={item} value={item}>
                  {item}
                </ComboboxItem>
              )}
            </ComboboxList>
          </ComboboxContent>
        </Combobox>
      </div>

      <Field className="w-full">
        <FieldLabel>Ration Type</FieldLabel>

        <Select value={rationType} onValueChange={setRationType}>
          <SelectTrigger>
            <SelectValue placeholder="Choose ration type" />
          </SelectTrigger>
          <SelectContent>
            <SelectGroup>
              <SelectItem value="nm">Non-Muslim</SelectItem>
              <SelectItem value="m">Muslim</SelectItem>
              <SelectItem value="nmsd">Non-Muslim Special Diet</SelectItem>
              <SelectItem value="vi">Vegetarian Indian</SelectItem>
              <SelectItem value="vc">Vegetarian Chinese</SelectItem>
            </SelectGroup>
          </SelectContent>
        </Select>
      </Field>

      {submitError ? (
        <p className="text-sm text-red-600">{submitError}</p>
      ) : null}
      {submitSuccess ? (
        <p className="text-sm text-green-600">{submitSuccess}</p>
      ) : null}

      <div className="flex items-center gap-2">
        <Button
          type="button"
          onClick={handleSubmit}
          disabled={!canSubmit || isSubmitting}
          className="flex-1"
        >
          {isSubmitting ? "Submitting..." : "Submit"}
        </Button>

        <Button
          type="button"
          variant="destructive"
          onClick={clearAll}
          disabled={isSubmitting || (!selectedName && !rationType)}
        >
          Clear
        </Button>
      </div>
    </div>
  );
}
